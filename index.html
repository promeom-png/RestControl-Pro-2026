<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RestoControl Pro - Smile Consultores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/lucide-static@0.321.0/font/lucide.css" rel="stylesheet">
    <style>
        .excel-input:focus { outline: 2px solid #16a34a; background-color: #f0fdf4; }
        .tab-active { border-bottom: 3px solid #16a34a; color: #16a34a; font-weight: bold; }
        .franchise-bg { background-color: #fff7ed; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .table-data input { width: 100%; height: 100%; border: none; padding: 6px; text-align: center; font-size: 11px; background: transparent; }
        .table-data th { font-size: 10px; white-space: nowrap; padding: 6px; text-align: center; border-color: #334155; }
        .bg-target { background-color: #f0fdf4 !important; }
        @media (max-width: 768px) { .hide-mobile { display: none; } }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800">
    <div id="app" class="flex h-screen overflow-hidden flex-col md:flex-row">
        
        <!-- Mobile Header -->
        <div class="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center shrink-0">
            <span class="font-bold text-green-500 tracking-tight uppercase">RestoControl Pro</span>
            <button @click="showMobileMenu = !showMobileMenu" class="p-2 bg-slate-800 rounded">
                <i class="lucide-menu"></i>
            </button>
        </div>

        <!-- Sidebar -->
        <aside :class="{'hidden': !showMobileMenu && isMobile, 'flex': showMobileMenu || !isMobile}" 
               class="w-full md:w-64 bg-slate-900 text-white flex-col shrink-0 z-50 absolute md:relative h-full">
            <div class="p-6 border-b border-slate-800 text-center hide-mobile">
                <h1 class="text-xl font-bold text-green-500 tracking-tight uppercase">RestoControl Pro</h1>
            </div>

            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button @click="changeView('dashboard')" :class="view === 'dashboard' ? 'bg-green-600' : 'hover:bg-slate-800'" class="w-full flex items-center justify-start gap-3 p-3 rounded-lg transition font-semibold">
                    <i class="lucide-layout-dashboard"></i> Dashboard
                </button>
                <button @click="changeView('data')" :class="view === 'data' ? 'bg-green-600' : 'hover:bg-slate-800'" class="w-full flex items-center justify-start gap-3 p-3 rounded-lg transition font-semibold">
                    <i class="lucide-edit-3"></i> Entrada de Datos
                </button>
                <button @click="changeView('restaurants')" :class="view === 'restaurants' ? 'bg-green-600' : 'hover:bg-slate-800'" class="w-full flex items-center justify-start gap-3 p-3 rounded-lg transition font-semibold">
                    <i class="lucide-settings"></i> Restaurantes / Backup
                </button>
            </nav>
            
            <div class="p-6 border-t border-slate-800">
                <a href="https://smileconsultores.com" target="_blank" class="text-[11px] text-slate-400 hover:text-white transition font-medium italic">
                    Hand made by smileconsultores
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden w-full">
            
            <!-- Dashboard View -->
            <div v-if="view === 'dashboard'" class="flex-1 flex flex-col overflow-hidden">
                <header class="bg-white border-b p-4 shadow-sm z-10">
                    <div class="flex flex-col gap-4">
                        <div class="flex flex-wrap gap-4 items-center justify-center">
                            <div class="text-center">
                                <label class="text-[10px] uppercase font-bold text-slate-400 block mb-1">Locales</label>
                                <div class="flex flex-wrap gap-1 justify-center max-w-full">
                                    <button @click="toggleAllRestaurants" class="px-2 py-1 text-[9px] border rounded bg-slate-50 font-bold uppercase">Todos</button>
                                    <button v-for="r in restaurants" :key="r.id" @click="toggleRes(r.id)"
                                        :class="selectedRestaurants.includes(r.id) ? (r.isFranchise ? 'bg-orange-600 text-white' : 'bg-green-600 text-white') : 'bg-white text-slate-400 border'"
                                        class="px-2 py-1 text-[9px] rounded font-medium transition">
                                        {{ r.name }}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-center gap-4 border-t pt-2">
                            <div class="flex flex-col items-center">
                                <label class="text-[9px] uppercase font-bold text-slate-400">Año</label>
                                <select v-model="filters.year" class="border-0 font-bold text-xs bg-transparent text-center focus:ring-0">
                                    <option v-for="y in [2024, 2025, 2026]" :value="y">{{y}}</option>
                                </select>
                            </div>
                            <div class="flex flex-col items-center">
                                <label class="text-[9px] uppercase font-bold text-slate-400">Desde - Hasta</label>
                                <div class="flex items-center gap-1">
                                    <select v-model="filters.startMonth" class="border-0 font-bold text-xs bg-transparent focus:ring-0"><option v-for="(m, i) in months" :value="i">{{m}}</option></select>
                                    <span class="text-xs">-</span>
                                    <select v-model="filters.endMonth" class="border-0 font-bold text-xs bg-transparent focus:ring-0"><option v-for="(m, i) in months" :value="i">{{m}}</option></select>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>

                <div class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- Tabla Ventas Dashboard -->
                    <div class="bg-white rounded-xl shadow-sm border overflow-x-auto">
                        <table class="w-full text-[11px] md:text-[12px]">
                            <thead class="bg-slate-100 text-slate-500 uppercase text-[9px] font-bold">
                                <tr>
                                    <th class="p-3 border-r text-left">Canal</th>
                                    <th class="p-3 bg-green-50 text-center">Ventas</th>
                                    <th class="p-3 bg-green-50 text-center">Desv/a.a.</th>
                                    <th class="p-3 bg-green-50 border-r text-center">Desv/Obj</th>
                                    <th class="p-3 text-center">PAX</th>
                                    <th class="p-3 border-r text-center">PAX/a.a.</th>
                                    <th class="p-3 text-center font-bold">T. Medio</th>
                                    <th class="p-3 text-center">TM/a.a.</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                <tr v-for="row in salesData" :key="row.label" :class="{'font-bold bg-green-50': row.isTotal}">
                                    <td class="p-3 border-r font-medium">{{ row.label }}</td>
                                    <td class="p-3 text-center">{{ formatInt(row.val) }}</td>
                                    <td class="p-3 text-center font-bold" :class="row.vsLY >= 0 ? 'text-green-600' : 'text-red-600'">{{ formatPct2(row.vsLY) }}</td>
                                    <td class="p-3 border-r text-center font-bold" :class="row.vsObj >= 0 ? 'text-green-600' : 'text-red-600'">{{ formatPct2(row.vsObj) }}</td>
                                    <td class="p-3 text-center">{{ formatInt(row.pax) }}</td>
                                    <td class="p-3 border-r text-center" :class="row.paxLY >= 0 ? 'text-green-600' : 'text-red-600'">{{ formatPct2(row.paxLY) }}</td>
                                    <td class="p-3 text-green-700 font-bold text-center">{{ formatDec(row.tm) }}</td>
                                    <td class="p-3 text-center font-medium" :class="row.tmLY >= 0 ? 'text-green-600' : 'text-red-600'">{{ formatPct2(row.tmLY) }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="bg-white rounded-xl shadow-sm border p-3 text-center">
                            <h4 class="text-[9px] uppercase font-bold text-slate-400">Personal %</h4>
                            <p :class="kpis.staffPct > kpis.staffTarget ? 'text-red-600' : 'text-green-600'" class="text-xl font-black">{{ formatPct2(kpis.staffPct) }}</p>
                            <p class="text-[8px] text-slate-400">Obj: {{formatDec(kpis.staffTarget)}}%</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border p-3 text-center">
                            <h4 class="text-[9px] uppercase font-bold text-slate-400">Compras %</h4>
                            <p :class="kpis.foodPct > kpis.foodTarget ? 'text-red-600' : 'text-green-600'" class="text-xl font-black">{{ formatPct2(kpis.foodPct) }}</p>
                            <p class="text-[8px] text-slate-400">Obj: {{formatDec(kpis.foodTarget)}}%</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border p-3 text-center">
                            <h4 class="text-[9px] uppercase font-bold text-slate-400">Vta/Mesa</h4>
                            <p class="text-xl font-black text-slate-700">{{ formatInt(kpis.salesPerTable) }}</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border p-3 text-center">
                            <h4 class="text-[9px] uppercase font-bold text-slate-400">Vta/EFT</h4>
                            <p class="text-xl font-black text-slate-700">{{ formatInt(kpis.salesPerEmployee) }}</p>
                        </div>
                    </div>

                    <!-- Gráficos -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pb-10">
                        <div class="bg-white p-3 rounded-xl shadow-sm border"><canvas id="chartSales" height="150"></canvas></div>
                        <div class="bg-white p-3 rounded-xl shadow-sm border"><canvas id="chartTM" height="150"></canvas></div>
                        <div class="bg-white p-3 rounded-xl shadow-sm border"><canvas id="chartPAX" height="150"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Entrada de Datos (RESPONSIVE) -->
            <div v-if="view === 'data'" class="flex-1 flex flex-col overflow-hidden">
                <header class="bg-white border-b p-4 flex flex-wrap items-center gap-4 shadow-sm justify-between">
                    <select v-model="activeDataTab" class="border rounded p-1 text-sm font-bold w-full md:w-48 bg-slate-50 text-center">
                        <option v-for="r in restaurants" :key="r.id" :value="r.id">{{ r.name }}</option>
                    </select>
                    <div class="flex gap-2 w-full md:w-auto">
                        <select v-model="filters.year" class="border rounded p-1 text-sm bg-slate-50 flex-1 text-center font-bold">
                            <option v-for="y in [2024,2025,2026]" :value="y">{{y}}</option>
                        </select>
                        <!-- Selector de mes visible solo en móvil para navegación rápida de tarjeta -->
                        <select v-if="isMobile" v-model="mobileEntryMonth" class="border rounded p-1 text-sm bg-slate-100 flex-1 text-center font-bold">
                            <option v-for="(m, i) in months" :value="i">{{m}}</option>
                        </select>
                    </div>
                </header>

                <div class="p-4 flex-1 overflow-auto bg-slate-100">
                    <!-- Vista Escritorio (Tabla Excel) -->
                    <div v-if="!isMobile" class="bg-white shadow-xl rounded border border-slate-300 overflow-hidden min-w-[1000px]">
                        <table class="w-full border-collapse table-data">
                            <thead class="bg-slate-800 text-white text-[9px] uppercase font-bold">
                                <tr>
                                    <th class="p-2 border border-slate-700 bg-slate-900 sticky left-0 z-20">Mes</th>
                                    <th class="p-2 border border-slate-700 bg-green-800">V. PDA</th>
                                    <th class="p-2 border border-slate-700 bg-green-800">Pax PDA</th>
                                    <th class="p-2 border border-slate-700 bg-green-700">V. Auto</th>
                                    <th class="p-2 border border-slate-700 bg-green-700">Pax Auto</th>
                                    <th class="p-2 border border-slate-700 bg-green-900">V. Deliv</th>
                                    <th class="p-2 border border-slate-700 bg-green-900">Pax Deliv</th>
                                    <th class="p-2 border border-slate-700 bg-red-800">Personal €</th>
                                    <th class="p-2 border border-slate-700 bg-orange-800">C1</th>
                                    <th class="p-2 border border-slate-700 bg-orange-800 border-r-2">C5</th>
                                    <th class="p-2 border border-slate-700 bg-slate-700">EFT</th>
                                    <th class="p-2 border border-slate-900 bg-green-200 text-slate-800 font-black">Vta. Obj.</th>
                                    <th class="p-2 border border-slate-900 bg-green-200 text-slate-800 font-black">% Per. Obj</th>
                                    <th class="p-2 border border-slate-900 bg-green-200 text-slate-800 font-black">% Cmp. Obj</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(m, midx) in months" :key="midx" class="hover:bg-green-50">
                                    <td class="p-2 border bg-slate-100 font-bold sticky left-0 z-10 text-[10px] text-center border-slate-300">{{ m }}</td>
                                    <td v-for="f in realDataFields" :key="f" class="border border-slate-200 p-0 bg-white">
                                        <input type="number" v-model.number="getRecord(activeDataTab, filters.year, midx)[f]" class="excel-input" @input="saveData">
                                    </td>
                                    <td v-for="obj in targetFields" :key="obj" class="border border-slate-300 p-0 bg-target">
                                        <input type="number" v-model.number="getRecord(activeDataTab, filters.year, midx)[obj]" class="excel-input font-bold text-green-800" @input="saveData">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Vista Móvil (Tarjetas de formulario) -->
                    <div v-else class="space-y-4">
                        <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-green-600">
                            <h3 class="text-lg font-bold text-center mb-4 uppercase text-slate-500">{{ months[mobileEntryMonth] }}</h3>
                            <div class="grid grid-cols-1 gap-4">
                                <div v-for="f in inputFieldsMobile" :key="f.key" class="flex flex-col">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1">{{ f.label }}</label>
                                    <input type="number" v-model.number="getRecord(activeDataTab, filters.year, mobileEntryMonth)[f.key]" 
                                           class="p-3 border rounded-lg text-lg font-bold bg-slate-50 focus:bg-white focus:ring-2 focus:ring-green-500" @input="saveData">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Restaurantes y Backup -->
            <div v-if="view === 'restaurants'" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <h2 class="text-xl font-bold">Maestro de Restaurantes</h2>
                    <div class="flex gap-2">
                        <button @click="exportBackup" class="bg-slate-700 text-white px-3 py-2 rounded text-xs flex items-center gap-2"><i class="lucide-download"></i> Backup</button>
                        <input type="file" id="importInput" class="hidden" @change="importBackup">
                        <button @click="triggerImport" class="bg-slate-100 text-slate-700 border px-3 py-2 rounded text-xs flex items-center gap-2"><i class="lucide-upload"></i> Restaurar</button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border overflow-x-auto">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-slate-100 uppercase text-[9px] text-slate-500 font-bold">
                            <tr>
                                <th class="p-4 text-center">Código</th>
                                <th class="p-4 text-center">Nombre Comercial</th>
                                <th class="p-4 text-center">Tipo</th>
                                <th class="p-4 text-center">Sala</th>
                                <th class="p-4 text-center">Terraza</th>
                                <th class="p-4 text-center"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            <tr v-for="r in restaurants" :key="r.id" :class="{'franchise-bg': r.isFranchise}">
                                <td class="p-2"><input v-model="r.code" @change="saveMeta" class="border rounded p-2 w-16 text-center bg-white"></td>
                                <td class="p-2"><input v-model="r.name" @change="saveMeta" class="border rounded p-2 w-full font-semibold bg-white text-center" :class="{'text-orange-600': r.isFranchise}"></td>
                                <td class="p-2 text-center">
                                    <select v-model="r.isFranchise" @change="saveMeta" class="border rounded p-1 text-[10px] bg-white">
                                        <option :value="false">Propio</option>
                                        <option :value="true">Franquicia</option>
                                    </select>
                                </td>
                                <td class="p-2 text-center"><input type="number" v-model.number="r.tables" @change="saveMeta" class="border rounded p-2 w-12 text-center bg-white"></td>
                                <td class="p-2 text-center"><input type="number" v-model.number="r.terrace" @change="saveMeta" class="border rounded p-2 w-12 text-center bg-white"></td>
                                <td class="p-2 text-center">
                                    <button @click="deleteRes(r.id)" class="text-red-400 p-2"><i class="lucide-trash text-lg"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button @click="addRestaurant" class="w-full md:w-auto bg-green-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg">+ Añadir Nuevo Local</button>
            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const view = ref('dashboard');
                const isMobile = ref(window.innerWidth < 768);
                const showMobileMenu = ref(false);
                const mobileEntryMonth = ref(new Date().getMonth());
                const activeDataTab = ref(1);
                const selectedRestaurants = ref([1]);
                const filters = ref({ year: 2024, startMonth: 0, endMonth: 11 });
                const charts = { sales: null, tm: null, pax: null };
                
                const restaurants = ref([
                    { id: 1, code: '001', name: 'Gran Vía', tables: 25, terrace: 10, isFranchise: false },
                    { id: 2, code: '002', name: 'Castellana', tables: 30, terrace: 15, isFranchise: false },
                    { id: 3, code: '003', name: 'Diagonal', tables: 20, terrace: 5, isFranchise: true }
                ]);

                const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const realDataFields = ['sales_pda', 'pax_pda', 'sales_auto', 'pax_auto', 'sales_deliv', 'pax_deliv', 'staff_cost', 'c1', 'c5', 'employees'];
                const targetFields = ['target_sales', 'target_staff_pct', 'target_food_pct'];
                
                const inputFieldsMobile = [
                    {label: 'Ventas PDA €', key: 'sales_pda'}, {label: 'Pax PDA', key: 'pax_pda'},
                    {label: 'Ventas Auto €', key: 'sales_auto'}, {label: 'Pax Auto', key: 'pax_auto'},
                    {label: 'Ventas Delivery €', key: 'sales_deliv'}, {label: 'Pax Delivery', key: 'pax_deliv'},
                    {label: 'Coste Personal €', key: 'staff_cost'}, {label: 'Compras C1 €', key: 'c1'},
                    {label: 'Compras C5 €', key: 'c5'}, {label: 'Plantilla EFT', key: 'employees'},
                    {label: 'Venta Objetivo €', key: 'target_sales'}
                ];

                const db = ref([]);

                const initDB = () => {
                    const savedMeta = localStorage.getItem('rc_v10_meta');
                    if(savedMeta) restaurants.value = JSON.parse(savedMeta);
                    const savedData = localStorage.getItem('rc_v10_db');
                    if(savedData) db.value = JSON.parse(savedData);
                    else {
                        const mock = [];
                        [2023, 2024].forEach(y => {
                            restaurants.value.forEach(r => {
                                for(let m=0; m<12; m++) {
                                    const base = 20000 + (Math.random() * 5000);
                                    mock.push({
                                        year: y, month: m, resId: r.id,
                                        sales_pda: base, pax_pda: base/22, sales_auto: base*0.4, pax_auto: (base*0.4)/18,
                                        sales_deliv: base*0.3, pax_deliv: (base*0.3)/25, staff_cost: base*0.32, 
                                        c1: base*0.22, c5: base*0.08, employees: 5,
                                        target_sales: base * 1.05, target_staff_pct: 32, target_food_pct: 30
                                    });
                                }
                            });
                        });
                        db.value = mock;
                        saveData();
                    }
                    if(restaurants.value.length > 0) activeDataTab.value = restaurants.value[0].id;
                    selectedRestaurants.value = restaurants.value.map(r => r.id);
                    setTimeout(updateCharts, 500);
                };

                const changeView = (v) => { view.value = v; showMobileMenu.value = false; if(v==='dashboard') setTimeout(updateCharts, 300); };
                const getRecord = (resId, year, month) => {
                    let rec = db.value.find(r => r.resId === resId && r.year === year && r.month === month);
                    if (!rec) {
                        rec = { year, month, resId, sales_pda:0, pax_pda:0, sales_auto:0, pax_auto:0, sales_deliv:0, pax_deliv:0, staff_cost:0, c1:0, c5:0, employees:0, target_sales:0, target_staff_pct:32, target_food_pct:30 };
                        db.value.push(rec);
                    }
                    return rec;
                };

                const saveData = () => localStorage.setItem('rc_v10_db', JSON.stringify(db.value));
                const saveMeta = () => localStorage.setItem('rc_v10_meta', JSON.stringify(restaurants.value));

                const exportBackup = () => {
                    const data = { meta: restaurants.value, db: db.value };
                    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `RestoControl_Backup_${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                };

                const triggerImport = () => document.getElementById('importInput').click();
                const importBackup = (e) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const data = JSON.parse(event.target.result);
                        restaurants.value = data.meta;
                        db.value = data.db;
                        saveMeta(); saveData();
                        alert('Datos restaurados correctamente');
                        location.reload();
                    };
                    reader.readAsText(e.target.files[0]);
                };

                const toggleRes = (id) => {
                    const i = selectedRestaurants.value.indexOf(id);
                    if(i > -1) selectedRestaurants.value.splice(i, 1);
                    else selectedRestaurants.value.push(id);
                };

                const toggleAllRestaurants = () => {
                    if(selectedRestaurants.value.length === restaurants.value.length) selectedRestaurants.value = [];
                    else selectedRestaurants.value = restaurants.value.map(r => r.id);
                };

                const addRestaurant = () => {
                    const id = Date.now();
                    restaurants.value.push({ id, code: '000', name: 'Nuevo Local', tables: 0, terrace: 0, isFranchise: false });
                    saveMeta();
                };

                const deleteRes = (id) => { if(confirm('¿Seguro que desea eliminar este restaurante?')) { restaurants.value = restaurants.value.filter(r => r.id !== id); saveMeta(); } };

                // Dashboard Logic
                const calcPeriod = (year, start, end, ids) => {
                    const subset = db.value.filter(r => ids.includes(r.resId) && r.year === year && r.month >= start && r.month <= end);
                    const sum = (k) => subset.reduce((a, b) => a + (b[k] || 0), 0);
                    const avg = (k) => subset.length ? (sum(k) / subset.length) : 0;
                    const vP = sum('sales_pda'), vA = sum('sales_auto'), vD = sum('sales_deliv');
                    const pP = sum('pax_pda'), pA = sum('pax_auto'), pD = sum('pax_deliv');
                    return { vP, pP, vA, pA, vD, pD, staff: sum('staff_cost'), c1: sum('c1'), c5: sum('c5'), emp: sum('employees'), totalV: vP+vA+vD, totalP: pP+pA+pD, targetV: sum('target_sales'), targetStaff: avg('target_staff_pct'), targetFood: avg('target_food_pct') };
                };

                const salesData = computed(() => {
                    const c = calcPeriod(filters.value.year, filters.value.startMonth, filters.value.endMonth, selectedRestaurants.value);
                    const l = calcPeriod(filters.value.year - 1, filters.value.startMonth, filters.value.endMonth, selectedRestaurants.value);
                    const row = (label, cv, cp, lv, lp, isT=false) => {
                        const ctm = cp ? cv/cp : 0, ltm = lp ? lv/lp : 0;
                        return { label, val: cv, pax: cp, tm: ctm, paxLY: lp ? (cp/lp)-1 : 0, tmLY: ltm ? (ctm/ltm)-1 : 0, vsLY: lv ? (cv/lv)-1 : 0, vsObj: isT ? (c.targetV ? (cv/c.targetV)-1 : 0) : 0.05, isTotal: isT };
                    };
                    return [ row('Camarero (PDA)', c.vP, c.pP, l.vP, l.pP), row('Autopedido', c.vA, c.pA, l.vA, l.pA), row('Delivery', c.vD, c.pD, l.vD, l.pD), row('TOTAL CADENA', c.totalV, c.totalP, l.totalV, l.totalP, true) ];
                });

                const kpis = computed(() => {
                    const c = calcPeriod(filters.value.year, filters.value.startMonth, filters.value.endMonth, selectedRestaurants.value);
                    const caps = restaurants.value.filter(r => selectedRestaurants.value.includes(r.id)).reduce((a,b) => a + b.tables + b.terrace, 0);
                    return { staffCost: c.staff, staffPct: c.totalV ? (c.staff/c.totalV)*100 : 0, foodCost: c.c1 + c.c5, foodPct: c.totalV ? ((c.c1+c.c5)/c.totalV)*100 : 0, salesPerTable: caps ? c.totalV / caps : 0, salesPerEmployee: c.emp ? c.totalV / c.emp : 0, totalEFT: c.emp, staffTarget: c.targetStaff, foodTarget: c.targetFood };
                });

                const updateCharts = () => {
                    if(view.value !== 'dashboard' || !document.getElementById('chartSales')) return;
                    const h = [];
                    for(let i=0; i<12; i++) {
                        const d = calcPeriod(filters.value.year, i, i, selectedRestaurants.value);
                        h.push({ v: d.totalV, tm: d.totalP ? d.totalV/d.totalP : 0, p: d.totalP });
                    }
                    const cfg = (label, data, color) => ({
                        type: 'line', data: { labels: months.map(m => m.substring(0,3)), datasets: [{ label, data, borderColor: color, backgroundColor: 'transparent', fill: false, tension: 0.4, borderWidth: 1.5, pointRadius: 2.5 }] },
                        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { display: true, grid: { display: false }, ticks: { font: { size: 8 } } }, x: { grid: { display: false }, ticks: { font: { size: 8 } } } } }
                    });
                    if(charts.sales) charts.sales.destroy(); if(charts.tm) charts.tm.destroy(); if(charts.pax) charts.pax.destroy();
                    charts.sales = new Chart(document.getElementById('chartSales'), cfg('Ventas', h.map(x=>x.v), '#16a34a'));
                    charts.tm = new Chart(document.getElementById('chartTM'), cfg('TM', h.map(x=>x.tm), '#f59e0b'));
                    charts.pax = new Chart(document.getElementById('chartPAX'), cfg('Pax', h.map(x=>x.p), '#2563eb'));
                };

                window.addEventListener('resize', () => { isMobile.value = window.innerWidth < 768; });
                watch([filters, selectedRestaurants, view], updateCharts, { deep: true });
                const formatInt = (v) => new Intl.NumberFormat('de-DE', { maximumFractionDigits: 0 }).format(v);
                const formatDec = (v) => new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(v);
                const formatPct2 = (v) => (v).toFixed(2) + '%';
                onMounted(initDB);
                return { view, isMobile, showMobileMenu, mobileEntryMonth, changeView, activeDataTab, selectedRestaurants, filters, restaurants, months, realDataFields, targetFields, inputFieldsMobile, getRecord, saveData, saveMeta, exportBackup, triggerImport, importBackup, toggleRes, toggleAllRestaurants, addRestaurant, deleteRes, salesData, kpis, formatInt, formatDec, formatPct2 };
            }
        }).mount('#app');
    </script>
</body>
</html>